# -----------------------------------------------------------------------------
# Dockerd Compose: MQTT Broker (EMQX), MongoDB & SBOM Aggregator (Express.js)
# -----------------------------------------------------------------------------

services:
  emqx:
    image: emqx/emqx:5.0.16
    container_name: sbom-emqx
    restart: unless-stopped
    ports:
      - "1883:1883"     # MQTT plain
      - "8883:8883"     # MQTT over TLS
      - "8081:8081"     # Dashboard (secure)
    environment:
      EMQX_NAME: "sbom-emqx-node"
      EMQX_ALLOW_ANONYMOUS: "false"
      EMQX_AUTH__PASSWORD_HASH: "bcrypt"
      EMQX_LISTENER__SSL__EXTERNAL__VERIFY: "verify_peer"
      EMQX_LISTENER__SSL__EXTERNAL__FAIL_IF_NO_PEER_CERT: "true"
      EMQX_LOADED_PLUGINS: "emqx_acl"
      EMQX_MQTT__MAX_PACKET_SIZE: "4MB"
    volumes:
      - emqx-data:/emqx/data
      - emqx-etc:/emqx/etc
      - ./certs/emqx:/opt/emqx/etc/certs:ro
      - ./acl.conf:/opt/emqx/etc/acl.conf:ro
    healthcheck:
      test: ["CMD", "sh", "-c", "emqx_ctl status"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sbom-net

  mongo:
    image: mongo:6.0
    container_name: sbom-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME_FILE: /run/secrets/mongo_root_user
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongo_root_pass
      MONGO_INITDB_DATABASE: iotrace
      MONGO_USER: user
      MONGO_PASSWORD: ${MONGO_PASSWORD}
    command: >
      mongod --tlsMode requireTLS
             --tlsCertificateKeyFile /certs/mongodb.pem
             --tlsCAFile /certs/ca.crt
    volumes:
      - mongo-data:/data/db
      - ./certs/mongodb:/certs:ro
      - ./certs/mongo-healthcheck/mongo-healthcheck.pem:/mongo-healthcheck.pem:ro
      - ./mongo_healthcheck.sh:/mongo_healthcheck.sh:ro
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    secrets:
      - mongo_root_user
      - mongo_root_pass
    healthcheck:
      test: ["CMD", "/mongo_healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sbom-net

  sbom-aggregator:
    build:
      context: ./aggregator
      dockerfile: Dockerfile
    container_name: sbom-aggregator
    restart: on-failure
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      CERTS_DIR: /app/certs
      TRUSTED_CA_DIR: /app/certs/ca.crt
      MONGO_CA_PATH: /app/certs/ca.crt
      MONGO_CLIENT_CERT: /app/certs/aggregator-mongo-client.pem
      MONGO_TLS: "true"
      MQTT_URL: "mqtts://emqx:8883"
      MQTT_USERNAME: ${MQTT_USERNAME}
      MQTT_PASSWORD: ${MQTT_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      DB_NAME: iotrace
      DB_USER: user
      DB_PASSWORD: ${MONGO_PASSWORD}
      DB_PORT: 27017

    depends_on:
      emqx:
        condition: service_healthy
      mongo:
        condition: service_healthy
    volumes:
      - ./certs/aggregator:/app/certs:ro
      # Development Only!
      - ./aggregator:/app
    healthcheck:
      test: ["CMD-SHELL", "curl -f --insecure https://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - sbom-net

  tracelet1:
    build:
      context: ./deamon
      dockerfile: Dockerfile
    container_name: sbom-tracelet-1
    hostname: sbom-tracelet-1
    entrypoint: ["/bin/sh", "-c", "./run.sh test-mode"]
    environment:
      DEVICE_ID: sbom-tracelet-1
    depends_on:
      sbom-aggregator:
        condition: service_healthy
      emqx:
        condition: service_healthy
    volumes:
      - ./deamon/certs/sbom-tracelet-1:/app/certs:ro
    networks:
      - sbom-net

  tracelet2:
    build:
      context: ./deamon
      dockerfile: Dockerfile
    container_name: sbom-tracelet-2
    hostname: sbom-tracelet-2
    entrypoint: ["/bin/sh", "-c", "./run.sh test-mode"]
    environment:
      DEVICE_ID: sbom-tracelet-2
    depends_on:
      sbom-aggregator:
        condition: service_healthy
      emqx:
        condition: service_healthy
    volumes:
      - ./deamon/certs/sbom-tracelet-2:/app/certs:ro
    networks:
      - sbom-net

  tracelet3:
    build:
      context: ./deamon
      dockerfile: Dockerfile
    container_name: sbom-tracelet-3
    hostname: sbom-tracelet-3
    entrypoint: ["/bin/sh", "-c", "./run.sh test-mode"]
    environment:
      DEVICE_ID: sbom-tracelet-3
    depends_on:
      sbom-aggregator:
        condition: service_healthy
      emqx:
        condition: service_healthy
    volumes:
      - ./deamon/certs/sbom-tracelet-3:/app/certs:ro
    networks:
      - sbom-net

# -----------------------------------------------------------------------------
# Volumes & Secrets
# -----------------------------------------------------------------------------

volumes:
  emqx-data:
  emqx-etc:
  mongo-data:

secrets:
  mongo_root_user:
    file: ./secrets/mongo_root_user.txt
  mongo_root_pass:
    file: ./secrets/mongo_root_pass.txt

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------

networks:
  sbom-net:
    driver: bridge
